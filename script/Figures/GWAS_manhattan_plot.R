#!/usr/bin/env Rscript

#   Function to read in Csv file used for plotting
readCsv <- function(filename) {
    data.file <- read.csv(
        file = filename,
        header = TRUE,
        na.strings = "NA"
    )
    
    #   In Chr_2016 column, replace "chr" with nothing and replace "H" with nothing
    data.file$Chr_2016 <- sub("chr", "", data.file$Chr_2016)
    data.file$Chr_2016 <- sub("H", "", data.file$Chr_2016)
    
    #   Pull out columns of interest
    gwas.data <- data.frame(
        SNP = data.file$SNP,
        PHENO = data.file$Phenotype,
        CHR = data.file$Chr_2016,
        BP = data.file$PhysPos_2016,
        P = data.file$P.value
    )
    return(gwas.data)
}

readGAPIT <- function(filename) {
    data.file <- read.csv(
        file = filename,
        header = TRUE,
        na.strings = "NA"
    )
    #   extract phenotype from filename
    rm.gapit <- strsplit(basename(path = filename), split = "GAPIT..")
    pheno.names <- unlist(strsplit(rm.gapit[[1]][2], split = ".GWAS.Results.csv"))
    data.file["pheno"] <- pheno.names
    return(data.file)
}

chrTicks <- function(chr1.whole, chr2.whole, chr3.whole, chr4.whole, chr5.whole, chr6.whole, chr7.whole) {
    #   Row 1 is the scaled position of the center of the chromosome
    #   Row 2 is the scaled position of the end of the chromosome
    chr1.t <- c(chr1.whole/2, chr1.whole)
    chr2.t <- c(chr2.whole/2 + chr1.whole, chr1.whole + chr2.whole)
    chr3.t <- c(chr3.whole/2 + chr1.whole + chr2.whole, chr1.whole + chr2.whole + chr3.whole)
    chr4.t <- c(chr4.whole/2 + chr1.whole + chr2.whole + chr3.whole, chr4.whole + chr1.whole + chr2.whole + chr3.whole)
    chr5.t <- c(chr5.whole/2 + chr1.whole + chr2.whole + chr3.whole + chr4.whole, chr5.whole + chr1.whole + chr2.whole + chr3.whole + chr4.whole)
    chr6.t <- c(chr6.whole/2 + chr1.whole + chr2.whole + chr3.whole + chr4.whole + chr5.whole, chr6.whole + chr1.whole + chr2.whole + chr3.whole + chr4.whole + chr5.whole)
    chr7.t <- c(chr7.whole/2 + chr1.whole + chr2.whole + chr3.whole + chr4.whole + chr5.whole + chr6.whole, chr7.whole + chr1.whole + chr2.whole + chr3.whole + chr4.whole + chr5.whole + chr6.whole)
    ticks <- cbind(chr1.t, chr2.t, chr3.t, chr4.t, chr5.t, chr6.t, chr7.t)
    return(ticks)
}

scalePsuedo <- function(df, chr1.whole, chr2.whole, chr3.whole, chr4.whole, chr5.whole, chr6.whole, chr7.whole) {
    #   Subset chromosomes
    df.chr1 <- subset(df, subset = df$CHR == 1)
    df.chr2 <- subset(df, subset = df$CHR == 2)
    df.chr3 <- subset(df, subset = df$CHR == 3)
    df.chr4 <- subset(df, subset = df$CHR == 4)
    df.chr5 <- subset(df, subset = df$CHR == 5)
    df.chr6 <- subset(df, subset = df$CHR == 6)
    df.chr7 <- subset(df, subset = df$CHR == 7)
    
    #   Add new column of scaled positions for plotting
    df.chr1["scaled.BP"] <- df.chr1$BP
    df.chr2["scaled.BP"] <- df.chr2$BP + chr1.whole
    df.chr3["scaled.BP"] <- df.chr3$BP + chr1.whole + chr2.whole
    df.chr4["scaled.BP"] <- df.chr4$BP + chr1.whole + chr2.whole + chr3.whole
    df.chr5["scaled.BP"] <- df.chr5$BP + chr1.whole + chr2.whole + chr3.whole + chr4.whole
    df.chr6["scaled.BP"] <- df.chr6$BP + chr1.whole + chr2.whole + chr3.whole + chr4.whole + chr5.whole
    df.chr7["scaled.BP"] <- df.chr7$BP + chr1.whole + chr2.whole + chr3.whole + chr4.whole + chr5.whole + chr6.whole
    
    #   Combine data frames
    d.all <- rbind(
        df.chr1[order(df.chr1$scaled.BP), ],
        df.chr2[order(df.chr2$scaled.BP), ],
        df.chr3[order(df.chr3$scaled.BP), ],
        df.chr4[order(df.chr4$scaled.BP), ],
        df.chr5[order(df.chr5$scaled.BP), ],
        df.chr6[order(df.chr6$scaled.BP), ],
        df.chr7[order(df.chr7$scaled.BP), ]
    )
    return(d.all)
}

#   Plot function
plot.manhattan <- function(x.val, y.val, color.pheno, p.sym, plot.title, ticks) {
    p <- plot(
        x = x.val,
        y = y.val,
        col = color.pheno,
        xlim = c(0, 4569031868),
        ylim = c(0, 12),
        pch = p.sym,
        cex = 1.5,
        xlab = "Chromosome",
        ylab = expression(-log[10](italic(p))),
        xaxt = "n",
        main = plot.title
    )
    axis(side = 1, at = c(0, ticks[2, ]), labels = FALSE, tick = TRUE)
    axis(side = 1, at = ticks[1, ], labels = c("1", "2", "3", "4", "5", "6", "7"), tick = FALSE)
    rect(
        xleft = c2.inv.start,
        xright = c2.inv.end,
        ybottom = 0,
        ytop = 12,
        col = adjustcolor("gray50", alpha.f = 0.25),
        border = NA
    )
    rect(
        xleft = c5.inv1.start,
        xright = c5.inv1.end,
        ybottom = 0,
        ytop = 12,
        col = adjustcolor("gray50", alpha.f = 0.25),
        border = NA
    )
    rect(
        xleft = c5.inv2.start,
        xright = c5.inv2.end,
        ybottom = 0,
        ytop = 12,
        col = adjustcolor("gray50", alpha.f = 0.25),
        border = NA
    )
}

main <- function() {
    #   Set path to files and directories
    #   This file contains only the significant SNPs
    gwas.filepath <- "/Users/chaochih/Dropbox/Landrace_Environmental_Association/Analyses/GWAS-GAPIT/compiled.5e_4.0.01.v2_physPos.csv"
    #   These files contain the full dataset including the significant SNPs for each bioclim variable
    full.d.fp <- list.files(path = "/Users/chaochih/Downloads/GWAS.Results 2", pattern = ".csv", full.names = TRUE)

    #   Read in GWAS significant SNPs data
    gwas.df <- readCsv(filename = gwas.filepath)
    #   Read in list of all GWAS data files
    full.d <- lapply(
        X = full.d.fp,
        FUN = readCsv
    )

    #   Ignore the following, need to shorten chunks of hardcoded code
    #   Key for pseudomolecular parts positions
    chr1H_part1 <- 312837513
    chr1H_part2 <- 245697919
    chr2H_part1 <- 393532674
    chr2H_part2 <- 374542350
    chr3H_part1 <- 394310633
    chr3H_part2 <- 305400481
    chr4H_part1 <- 355061206
    chr4H_part2 <- 291998952
    chr5H_part1 <- 380865482
    chr5H_part2 <- 289164678
    chr6H_part1 <- 294822070
    chr6H_part2 <- 288558443
    chr7H_part1 <- 325797516
    chr7H_part2 <- 331426484
    #   Whole chromosome size
    chr1.w <- chr1H_part1 + chr1H_part2
    chr2.w <- chr2H_part1 + chr2H_part2
    chr3.w <- chr3H_part1 + chr3H_part2
    chr4.w <- chr4H_part1 + chr4H_part2
    chr5.w <- chr5H_part1 + chr5H_part2
    chr6.w <- chr6H_part1 + chr6H_part2
    chr7.w <- chr7H_part1 + chr7H_part2

    #   Define chr2 and chr5 inverted regions
    c2.inv.start <- 267303750 + chr1.w
    c2.inv.end <- 508786535 + chr1.w
    c5.inv1.start <- 126746171 + chr1.w + chr2.w + chr3.w + chr4.w
    c5.inv1.end <- 305528375 + chr1.w + chr2.w + chr3.w + chr4.w
    c5.inv2.start <- 598975647 + chr1.w + chr2.w + chr3.w + chr4.w
    c5.inv2.end <- 609073831 + chr1.w + chr2.w + chr3.w + chr4.w
    
    #   Generate ticks used for plots
    ticks <- chrTicks(chr1.whole = chr1.w, chr2.whole = chr2.w, chr3.whole = chr3.w, chr4.whole = chr4.w, chr5.whole = chr5.w, chr6.whole = chr6.w, chr7.whole = chr7.w)
    
    #   Scale physical positions in data for accurate representation in plots

    #   Generate Plots
    #   Bio1, 6, and 11
    par(mfrow = c(3, 1))
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio1"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio1"]),
        color.pheno = "#005C9E",
        p.sym = 17,
        plot.title = "GWAS BIO1 - Annual Mean Temperature"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio6"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio6"]),
        color.pheno = "#005C9E",
        p.sym = 17,
        plot.title = "GWAS BIO6 - Min Temperature of Coldest Month"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio11"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio11"]),
        color.pheno = "#005C9E",
        p.sym = 17,
        plot.title = "GWAS BIO11 - Mean Temperature of Coldest Quarter"
    )

    par(mfrow = c(4,1))
    #   Bio2, 3, 4, and 5
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio2"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio2"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO2 - Mean Diurnal Range (Mean of monthly (max temp - min temp))"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio3"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio3"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO3 - Isothermality (BIO2/BIO7) (* 100)"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio4"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio4"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO4 - Temperature Seasonality (standard deviation *100)"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio5"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio5"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO5 - Max Temperature of Warmest Month"
    )

    #   Bio7, 8, 9, and 10
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio7"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio7"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO7 - Temperature Annual Range (BIO5-BIO6)"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio8"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio8"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO8 - Mean Temperature of Wettest Quarter"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio9"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio9"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO9 - Mean Temperature of Driest Quarter"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio10"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio10"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO10 - Mean Temperature of Warmest Quarter"
    )

    #   Bio12, 13, 14, and 15
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio12"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio12"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO12 - Annual Precipitation"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio13"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio13"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO13 - Precipitation of Wettest Month"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio14"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio14"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO14 - Precipitation of Driest Month"
    )
    arrows(
        x0 = d.all$scaled.BP[d.all$SNP == "11_20784" & d.all$PHENO == "bio14"],
        y1 = -log10(d.all$P[d.all$SNP == "11_20784" & d.all$PHENO == "bio14"]),
        y0 = -log10(d.all$P[d.all$SNP == "11_20784" & d.all$PHENO == "bio14"] + (10 * 0.0001636497)),
        length = 0.1, lwd = 2
    )
    text(
        x = d.all$scaled.BP[d.all$SNP == "11_20784" & d.all$PHENO == "bio14"],
        y = -log10(d.all$P[d.all$SNP == "11_20784" & d.all$PHENO == "bio14"] + (10 * 0.0001636497) + 0.05),
        labels = "11_20784\n(BIO14, BIO17)"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio15"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio15"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO15 - Precipitation Seasonality (Coefficient of Variation)"
    )


    #   Bio16, 17, 18, and 19
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio16"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio16"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO16 - Precipitation of Wettest Quarter"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio17"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio17"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO17 - Precipitation of Driest Quarter"
    )
    arrows(
        x0 = d.all$scaled.BP[d.all$SNP == "11_20784" & d.all$PHENO == "bio17"],
        y1 = -log10(d.all$P[d.all$SNP == "11_20784" & d.all$PHENO == "bio17"]),
        y0 = -log10(d.all$P[d.all$SNP == "11_20784" & d.all$PHENO == "bio17"] + (10 * 0.0001636497)),
        length = 0.1, lwd = 2
    )
    text(
        x = d.all$scaled.BP[d.all$SNP == "11_20784" & d.all$PHENO == "bio17"],
        y = -log10(d.all$P[d.all$SNP == "11_20784" & d.all$PHENO == "bio17"] + (10 * 0.0001636497) + 0.05),
        labels = "11_20784\n(BIO14, BIO17)"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio18"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio18"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO18 - Precipitation of Warmest Quarter"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "bio19"],
        y.val = -log10(d.all$P[d.all$PHENO == "bio19"]),
        color.pheno = "#BD1550",
        p.sym = 20,
        plot.title = "GWAS BIO19 - Precipitation of Coldest Quarter"
    )

    #   Latitude, longitude, and altitude
    par(mfrow = c(3, 1))
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "Latitude"],
        y.val = -log10(d.all$P[d.all$PHENO == "Latitude"]),
        color.pheno = "orange",
        p.sym = 20,
        plot.title = "GWAS - Latitude"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "Longitude"],
        y.val = -log10(d.all$P[d.all$PHENO == "Longitude"]),
        color.pheno = "orange",
        p.sym = 20,
        plot.title = "GWAS - Longitude"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "altitude"],
        y.val = -log10(d.all$P[d.all$PHENO == "altitude"]),
        color.pheno = "orange",
        p.sym = 20,
        plot.title = "GWAS - Altitude"
    )

    #   IC1, 2, and 3
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "IC1"],
        y.val = -log10(d.all$P[d.all$PHENO == "IC1"]),
        color.pheno = "limegreen",
        p.sym = 20,
        plot.title = "GWAS IC1 - Independent components applied to BIO1-19"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "IC2"],
        y.val = -log10(d.all$P[d.all$PHENO == "IC2"]),
        color.pheno = "limegreen",
        p.sym = 20,
        plot.title = "GWAS IC2 - Independent components applied to BIO1-19"
    )
    plot.manhattan(
        x.val = d.all$scaled.BP[d.all$PHENO == "IC3"],
        y.val = -log10(d.all$P[d.all$PHENO == "IC3"]),
        color.pheno = "limegreen",
        p.sym = 20,
        plot.title = "GWAS IC3 - Independent components applied to BIO1-19"
    )
}

main()
